{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "Location": {
            "type": "string"
        },
        "VNetName": {
            "type": "string",
            "defaultvalue": "azfw-sample-vnet"

        },
         "VNetAddressPrefix": {
            "type": "string",
            "defaultvalue": "10.0.0.0/24"
        },
         "FirewallSubnetAddressPrefix": {
            "type": "string",
            "defaultvalue": "10.0.0.0/26"
        },
        "IPPrefixLength": {
            "type": "int",
            "allowedvalues": [ 
                28, 29, 30, 31, 124, 125, 126, 127
             ]
        },
        "IPVersion": {
            "type": "string",
            "defaultvalue": "IPv4",
            "allowedvalues": [ 
                "IPv4",
                "IPv6"
             ]
        },
        "PublicIPCount": {
            "type": "int",
            "metadata": {
                "description": "Number of Public IP addresses used by Azure Firewall"
            }
        }
    },
    "variables": {
        "VNetName": "[parameters('VNetName')]",
        "FirewallName":  "[concat(variables('VNetName'), '-fw')]",
        "PublicIPName":  "[concat(variables('FirewallName'), '-pip-')]",
        "IPPrefixName": "[concat(variables('FirewallName'), '-ipprefix')]",
        "FirewallSubnetId": "[resourceId('Microsoft.Network/virtualNetworks/subnets',variables('VNetName'), 'AzureFirewallSubnet')]",
        "FirewallSubnetJSON": "[json(format('{{\"id\": \"{0}\"}}', variables('FirewallSubnetId')))]",
        "copy": [
            {
                "name": "FirewallIpConfigurations",
                "count": "[parameters('PublicIPCount')]",
                "input": {
                    "name": "[concat('IpConf', copyIndex('FirewallIpConfigurations',1))]",
                    "properties": {
                        "subnet": "[if(equals(copyIndex('FirewallIpConfigurations',1), 1), variables('FirewallSubnetJSON'), json('null'))]",
                        "publicIPAddress": {
                            "id": "[resourceId('Microsoft.Network/publicIPAddresses', concat(variables('PublicIPName'), copyIndex('FirewallIpConfigurations',1)))]"
                        }
                    }
                }
            }
        ]
    },
    "resources": [
        {
            "comments": "Central hub network",
            "type": "Microsoft.Network/virtualNetworks",
            "apiVersion": "2019-09-01",
            "name": "[variables('VNetName')]",
            "location": "[parameters('Location')]",
            "dependsOn": [
            ],
            "properties": {
                "addressSpace": {
                    "addressPrefixes": [
                        "[parameters('VNetAddressPrefix')]"
                    ]
                },
                "subnets": [
                    {
                        "name": "AzureFirewallSubnet",
                        "properties": {
                            "addressPrefix": "[parameters('FirewallSubnetAddressPrefix')]"                            
                        }
                    }            
                    
                ]                
            }
        },
        {
            "comments": "Public IP Prefix",
            "apiVersion": "2018-07-01",
            "type": "Microsoft.Network/publicipprefixes",
            "name": "[variables('IpPrefixName')]",
            "location": "[parameters('location')]",
            "dependsOn": [],
            "properties": {
                "prefixLength": "[parameters('IPPrefixLength')]",
                "publicIPAddressVersion": "[parameters('ipVersion')]",
                "ipTags": []
            },
            "sku": {
                "name": "Standard",
                "tier": "Regional"
            }
        },
        {
            "comments": "Public IPs for Azure firewall",            
            "apiVersion": "2020-05-01",
            "type": "Microsoft.Network/publicIpAddresses",
            "name": "[concat(variables('PublicIPName'), copyIndex(1))]",
            "location": "[parameters('Location')]",            
            "dependsOn": [
                "[concat('Microsoft.Network/publicipprefixes/', variables('IPPrefixName'))]"
            ],
            "sku": {
                "name": "Standard"
            },
            "properties": {
                "publicIPAllocationMethod": "Static",
                "publicIPPrefix": {
                    "id": "[resourceId('Microsoft.Network/publicipprefixes',variables('IPPrefixName'))]"
                }                
            },
            "copy": {
                "name": "publicipcopy",
                "count": "[parameters('PublicIPCount')]"
            }

            
        },
        {
            "comments": "Azure Firewall",
            "apiVersion": "2020-05-01",
            "type": "Microsoft.Network/azureFirewalls",
            "name": "[variables('FirewallName')]",
            "location": "[parameters('Location')]",            
            "dependsOn": [
                "[parameters('VNetName')]",
                "publicipcopy"
            ],
            "properties": {
                "threatIntelMode": "Alert",
                "ipConfigurations": "[variables('FirewallIpConfigurations')]"
                
            }
        }
    ]
}